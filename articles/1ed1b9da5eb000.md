---
title: "Goã§å®Ÿè£…ã—ãŸãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã§ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ HTTPS é€šä¿¡ã™ã‚‹"
emoji: "ğŸ¦­"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Go", "Docker", "HTTPS", "Nextjs"]
published: true
---

ã“ã®è¨˜äº‹ã§ã¯ã€Go ã§å®Ÿè£…ã—ãŸãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ HTTPS é€šä¿¡ã‚’å®Ÿç¾ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚
ä»Šå›

## ã¯ã˜ã‚ã«

docker-composeã§æ§‹ç¯‰ã—ãŸãƒ­ãƒ¼ã‚«ãƒ«ã®é–‹ç™ºç’°å¢ƒã§ã‚‚ HTTPS ã§é€šä¿¡ã•ã›ãŸããªã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚å®Ÿç¾ã™ã‚‹æ–¹æ³•ã¨ã—ã¦ã¯ã€ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚

ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚’å®Ÿè£…ã™ã‚‹ã«ã¯ Nginx ãªã©ã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ãŒä¸€èˆ¬çš„ã§ã™ãŒã€ä»Šå›ã¯ Go ã§å®Ÿè£…ã—ã¦ã¿ã¾ã™ã€‚Go ã®æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã‚ã‚‹ `net/http/httputil` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã€ [ReverseProxy](https://pkg.go.dev/net/http/httputil#ReverseProxy) ã‚’ä½¿ç”¨ã—ã¦ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚’å®Ÿè£…ã§ãã¾ã™ã€‚

## æ§‹æˆ

ä»¥ä¸‹ã®ã‚ˆã†ãªæ§‹æˆã«ã—ã¾ã™ã€‚

![æ§‹æˆå›³](/images/drawio/go-reverse-proxy.drawio.png)

- ãƒ–ãƒ©ã‚¦ã‚¶-ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·é–“: HTTPS
- Next.js ã‚³ãƒ³ãƒ†ãƒŠ-ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·é–“: HTTPS
- ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·-Next.js ã‚³ãƒ³ãƒ†ãƒŠ/API ã‚³ãƒ³ãƒ†ãƒŠé–“: HTTP

## æ‰‹é †

### 1. `docker-compose.yml` ã®ä½œæˆ

```yaml
version: "3.9"

services:
  reverse-proxy:
    hostname: reverse-proxy
    build:
      context: .
      dockerfile: ./reverse-proxy/Dockerfile
    volumes:
      - .:/workspace:cached
    ports:
      - "1443:443"
      - "3000:444"

  webapp:
    hostname: webapp
    build:
      context: .
      dockerfile: ./webapp/Dockerfile
    volumes:
      - .:/workspace:cached

  api:
    hostname: api
    build:
      context: .
      dockerfile: ./api/Dockerfile
    volumes:
      - .:/workspace:cached
```
#### `hostname`

`hostname` ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã€Docker Network å†…ã§åå‰è§£æ±ºãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ä¾‹ãˆã°ã€`webapp`ã‚³ãƒ³ãƒ†ãƒŠã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹éš›ã¯ã€`webapp:3000`ã¨æŒ‡å®šã—ã¾ã™ã€‚

#### ãƒãƒ¼ãƒˆãƒãƒƒãƒ”ãƒ³ã‚°

```yaml
ports:
  - "1443:443"
  - "3000:444"
```

ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã‹ã‚‰`reverse-proxy`ã‚’çµŒç”±ã—ã¦`webapp`ã‚„`api`ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã„ã®ã§ã€`reverse-proxy`ã®ãƒãƒ¼ãƒˆã®ã¿ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã¾ã™ã€‚

### 2. `Dockerfile` ã®ä½œæˆ

```dockerfile
# ./reverse-proxy/Dockerfile
FROM golang:1.20.3

ENV GO111MODULE on

WORKDIR /workspace/reverse-proxy

CMD ["go", "run", "main.go"]
```

ãã®ä»–ã®ã‚³ãƒ³ãƒ†ãƒŠã® `Dockerfile` ã«ã¤ã„ã¦ã¯å‰²æ„›ã—ã¾ã™ã€‚

### 3. è¨¼æ˜æ›¸ã¨ç§˜å¯†éµã®ä½œæˆ

[mkcert](https://github.com/FiloSottile/mkcert)ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ä¸Šã§è¨¼æ˜æ›¸ã¨ç§˜å¯†éµã‚’ä½œæˆã—ã¾ã™ã€‚Docker Network å†…ã§åå‰è§£æ±ºã§ãã‚‹ã‚ˆã†ã«ã€`localhost` ã¨ `host.docker.internal` ã®2ã¤ã‚’æŒ‡å®šã—ã¾ã™ã€‚

```bash
mkcert -cert-file ./cert/localhost.pem -key-file ./cert/localhost-key.pem localhost "host.docker.internal"
```

`./cert` ã« `localhost.pem` ã¨ `localhost-key.pem` ãŒä½œæˆã•ã‚Œã¾ã™ã€‚

### 4. `main.go` ã®ä½œæˆ

`net/http/httputil` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã® [ReverseProxy](https://pkg.go.dev/net/http/httputil#ReverseProxy) ã‚’ä½¿ç”¨ã—ã¦ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```go
package main

import (
	"log"
	"net/http"
	"net/http/httputil"
	"strconv"
	"sync"
)

func runProxyServer(port int, forwardHost string) {
	director := func(request *http.Request) {
		request.URL.Scheme = "http"
		request.URL.Host = forwardHost
	}

	rp := &httputil.ReverseProxy{Director: director}
	server := http.Server{
		Addr:    ":" + strconv.Itoa(port),
		Handler: rp,
	}

	if err := server.ListenAndServeTLS("../cert/localhost.pem", "../cert/localhost-key.pem"); err != nil {
		log.Fatal(err.Error())
	}
}

func main() {
	var wg sync.WaitGroup

	wg.Add(2)

	go func() {
		runProxyServer(443, "api:8080")
		wg.Done()
	}()

	go func() {
		runProxyServer(444, "webapp:3000")
		wg.Done()
	}()

	wg.Wait()
}
```

#### `runProxyServer()`

ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹é–¢æ•°ã§ã™ã€‚

- ç¬¬2å¼•æ•°ã® `forwardHost` ã«ã¯ã€ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚’çµŒç”±ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã„ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ›ã‚¹ãƒˆåã‚’æŒ‡å®šã—ã¾ã™ã€‚
- `director` ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è»¢é€å…ˆã®ãƒ›ã‚¹ãƒˆ (`forwardHost`) ã«æ›¸ãæ›ãˆã¾ã™ã€‚è»¢é€å…ˆã¨ã®é€šä¿¡ã¯ HTTP ãªã®ã§ã€URL ã®ã‚¹ã‚­ãƒ¼ãƒ ã‚’ `http` ã«æ›¸ãæ›ãˆã¾ã™ã€‚
- `server.ListenAndServeTLS()` ã§å…ˆã»ã©ä½œæˆã—ãŸè¨¼æ˜æ›¸ã¨ç§˜å¯†éµã‚’æŒ‡å®šã—ã€ HTTPS ã§ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¾ã™ã€‚

#### `main()`

`webapp` (Next.js ã‚³ãƒ³ãƒ†ãƒŠ) ã¨`api` (API ã‚³ãƒ³ãƒ†ãƒŠ) ã®ä¸¡æ–¹ã‚’ HTTPS ã§é€šä¿¡ã•ã›ã‚‹ãŸã‚ã«ã€åˆ¥ã‚´ãƒ«ãƒ¼ãƒãƒ³ã§2ã¤ã®ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™ã€‚

## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®š

Next.js ã¨ API ã®è¨­å®šã§ã™ã€‚æœ¬é¡Œã§ã¯ãªã„ã®ã§ã€è©³ã—ãã¯[GitHub](https://github.com/kngnkg/go-reverse-proxy)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### 1. API ã‚³ãƒ³ãƒ†ãƒŠ

`Hello World !` ã‚’è¿”ã™ã ã‘ã® API ã§ã™ã€‚

```go
// ./api/main.go
package main

import (
	"fmt"
	"net/http"
)

func main() {
	http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
		w.Header().Set("Access-Control-Allow-Origin", "https://localhost:3000")
		w.Header().Set("Access-Control-Allow-Methods", "GET, OPTIONS")
		fmt.Fprint(w, "Hello World !")
	})

	http.ListenAndServe(":8080", nil)
}
```

### 2. Next.js ã‚³ãƒ³ãƒ†ãƒŠã®è¨­å®š

#### è¨¼æ˜æ›¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ã‚µãƒ¼ãƒãƒ¼å´ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹éš›ã«è¨¼æ˜æ›¸ãŒå¿…è¦ãªã®ã§ã€`Dockerfile` å†… ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```dockerfile
# ./webapp/Dockerfile

COPY cert/localhost.pem /usr/local/share/ca-certificates/localhost.crt
RUN update-ca-certificates
```

#### è‡ªå·±è¨¼æ˜æ›¸ã®æ¤œè¨¼ã‚’ç„¡åŠ¹åŒ–

è‡ªå·±è¨¼æ˜æ›¸ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã®ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«ç½²åæ¤œè¨¼ã«å¤±æ•—ã—ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚`.env.local` ã«ä»¥ä¸‹ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦è¨¼æ˜æ›¸ã®æ¤œè¨¼ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã™ã€‚æœ¬ç•ªç’°å¢ƒãªã©ã§ã¯è¨­å®šã—ãªã„ã§ãã ã•ã„ã€‚

```env
# ./webapp/.env.local
NODE_TLS_REJECT_UNAUTHORIZED=0
```

#### ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ä½œæˆ

ä»Šå›ã¯[app router](https://nextjs.org/docs/app)ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ `./components/ClientComponent.tsx` ã§ã™ã€‚

```tsx
// ./components/ClientComponent.tsx
"use client";

import * as React from "react";

const fetchFromClient = async () => {
  // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§å®Ÿè¡Œã•ã‚Œã‚‹ã®ã§ã€`localhost:1443`ã‚’æŒ‡å®šã—ã¾ã™ã€‚
  const res = await fetch("https://localhost:1443");
  if (!res.ok) {
    throw new Error("Failed to fetch data");
  }

  const data = await res.text();
  return data;
};

export const ClientComponent: React.FC = () => {
  const [data, setData] = React.useState<string | null>(null);

  const onClick = async () => {
    const data = await fetchFromClient();
    setData(data);
  };

  return (
    <>
      <p>From Client: {data}</p>
      <button onClick={onClick} className="bg-blue-500 text-white py-2 px-4 rounded">fetch</button>
    </>
  );
};
```

ã‚µãƒ¼ãƒãƒ¼å´ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ `./app/page.tsx` ã§ã™ã€‚

```tsx
// ./app/page.tsx
import { ClientComponent } from "../components/ClientComponent";

const fetchFromServer = async () => {
  // ã‚µãƒ¼ãƒãƒ¼å´ã§å®Ÿè¡Œã•ã‚Œã‚‹ã®ã§ã€`host.docker.internal:1443`ã‚’æŒ‡å®šã—ã¾ã™ã€‚
  const res = await fetch("https://host.docker.internal:1443");
  if (!res.ok) {
    throw new Error("Failed to fetch data");
  }

  const data = await res.text();
  return data;
};

export default async function Home() {
  const data = await fetchFromServer();

  return (
    <main className="flex items-center justify-center">
      <div>
      <p>From Server: {data}</p>
      <ClientComponent />
      </div>
    </main>
  );
}
```

## å‹•ä½œç¢ºèª

### 1. ã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•

```bash
docker-compose up -d
```

### 2. ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ã‚¯ã‚»ã‚¹

[https://localhost:3000](https://localhost:3000)ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚

![](/images/2023-08-11-17.28.17.png)

ã‚µãƒ¼ãƒãƒ¼å´ã§ãƒ•ã‚§ãƒƒãƒã§ãã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

### 3. ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

![](/images/client-fetch.gif)

![](/images/2023-08-11-17.31.12.png)

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ãƒ•ã‚§ãƒƒãƒã§ãã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

## ã¾ã¨ã‚

ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚’ä½¿ç”¨ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã® HTTPS é€šä¿¡ã‚’å®Ÿç¾ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚Go ã®æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã‚ã‚‹ `net/http/httputil` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã® [ReverseProxy](https://pkg.go.dev/net/http/httputil#ReverseProxy) ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ç°¡å˜ã«ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚’å®Ÿè£…ã§ãã¾ã™ã€‚

## å‚è€ƒ

https://pkg.go.dev/net/http/httputil#ReverseProxy

https://kido0617.github.io/go/2016-08-10-reverse-proxy/
