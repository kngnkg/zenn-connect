---
title: "ãƒ­ãƒ¼ã‚«ãƒ«ã®ã‚³ãƒ³ãƒ†ãƒŠåŒå£«ã‚’HTTPSã§é€šä¿¡ã•ã›ã‚‹ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚’Goã§ä½œæˆã™ã‚‹"
emoji: "ğŸ¡"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Go", "Docker", "HTTPS", "TLS", "DockerCompose"]
published: false
---

ãƒ­ãƒ¼ã‚«ãƒ«ã®é–‹ç™ºç’°å¢ƒã§ã€ã‚³ãƒ³ãƒ†ãƒŠåŒå£«ã‚’HTTPSã§é€šä¿¡ã•ã›ãŸããªã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®è¨˜äº‹ã§ã¯ã€ãƒ­ãƒ¼ã‚«ãƒ«ã®ã‚³ãƒ³ãƒ†ãƒŠåŒå£«ã‚’HTTPSã§é€šä¿¡ã•ã›ã‚‹ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚’Goã§ä½œæˆã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

## æ¦‚è¦

![](/images/drawio/go-reverse-proxy.drawio.png)

ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã‹ã‚‰ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚’çµŒç”±ã—ã¦ã€Next.js ã‚³ãƒ³ãƒ†ãƒŠ ã‚„ API ã‚³ãƒ³ãƒ†ãƒŠã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚Next.js ãŒ API ã‚³ãƒ³ãƒ†ãƒŠã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹éš›ã‚‚ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚’çµŒç”±ã—ã¾ã™ã€‚

## æ‰‹é †

### 1. `docker-compose.yml` ã®ä½œæˆ

```yaml
version: "3.9"

services:
  reverse-proxy:
    hostname: reverse-proxy
    build:
      context: .
      dockerfile: ./reverse-proxy/Dockerfile
    volumes:
      - .:/workspace:cached
    ports:
      - "1443:443"
      - "3000:444"

  webapp:
    hostname: webapp
    build:
      context: .
      dockerfile: ./webapp/Dockerfile
    volumes:
      - .:/workspace:cached

  api:
    hostname: api
    build:
      context: .
      dockerfile: ./api/Dockerfile
    volumes:
      - .:/workspace:cached

```
#### `hostname`

`hostname` ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã€Docker Network å†…ã§åå‰è§£æ±ºãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ä¾‹ãˆã°ä»Šå›ã®å ´åˆã€`reverse-proxy` ã‹ã‚‰ `webapp` ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹éš›ã¯ã€`http://webapp:3000` ã¨ã„ã† URL ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

#### ãƒãƒ¼ãƒˆãƒãƒƒãƒ”ãƒ³ã‚°

```yaml
ports:
  - "1443:443"
  - "3000:444"
```

ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã‹ã‚‰`reverse-proxy`ã‚’çµŒç”±ã—ã¦`webapp`ã‚„`api`ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã„ã®ã§ã€`reverse-proxy`ã®ãƒãƒ¼ãƒˆã®ã¿ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã¾ã™ã€‚

### 2. `Dockefile` ã®ä½œæˆ

```dockerfile
# reverse-proxy/Dockerfile

FROM golang:1.20.3-bullseye

ENV GO111MODULE on

WORKDIR /workspace/reverse-proxy

CMD ["go", "run", "main.go"]
```

### 3. è¨¼æ˜æ›¸ã¨ç§˜å¯†éµã®ä½œæˆ

[mkcert](https://github.com/FiloSottile/mkcert)ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ä¸Šã§è¨¼æ˜æ›¸ã¨ç§˜å¯†éµã‚’ä½œæˆã—ã¾ã™ã€‚

#### ãƒ­ãƒ¼ã‚«ãƒ«CAã®ä½œæˆ

```bash
mkcert -install
```

#### ãƒ­ãƒ¼ã‚«ãƒ«CAã‚’ä½¿ç”¨ã—ã¦è¨¼æ˜æ›¸ã¨ç§˜å¯†éµã‚’ä½œæˆ

```bash
mkcert -cert-file ./cert/localhost.pem -key-file ./cert/localhost-key.pem localhost "host.docker.internal"
```

`./cert`ã« `localhost.pem` ã¨ `localhost-key.pem` ãŒä½œæˆã•ã‚Œã¾ã™ã€‚

### 4. `main.go` ã®ä½œæˆ

```go
package main

import (
	"log"
	"net/http"
	"net/http/httputil"
	"strconv"
	"sync"
)

func runProxyServer(port int, forwardHost string) {
	director := func(request *http.Request) {
		request.URL.Scheme = "http"
		request.URL.Host = forwardHost
	}

	rp := &httputil.ReverseProxy{Director: director}
	server := http.Server{
		Addr:    ":" + strconv.Itoa(port),
		Handler: rp,
	}

	if err := server.ListenAndServeTLS("../cert/localhost.pem", "../cert/localhost-key.pem"); err != nil {
		log.Fatal(err.Error())
	}
}

func main() {
	var wg sync.WaitGroup

	wg.Add(2)

	go func() {
		runProxyServer(443, "api:8080")
		wg.Done()
	}()

	go func() {
		runProxyServer(444, "webapp:3000")
		wg.Done()
	}()

	wg.Wait()
}
```

#### `runProxyServer()`

ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹é–¢æ•°ã§ã™ã€‚`server.ListenAndServeTLS()` ã§å…ˆã»ã©ä½œæˆã—ãŸè¨¼æ˜æ›¸ã¨ç§˜å¯†éµã‚’æŒ‡å®šã—ã€ HTTPS ã§ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¾ã™ã€‚

#### `main()`

`webapp` (Next.js ã‚³ãƒ³ãƒ†ãƒŠ) ã¨`api` (API ã‚³ãƒ³ãƒ†ãƒŠ) ã®ä¸¡æ–¹ã‚’ HTTPS ã§é€šä¿¡ã•ã›ã‚‹ãŸã‚ã«ã€åˆ¥ã‚´ãƒ«ãƒ¼ãƒãƒ³ã§2ã¤ã®ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™ã€‚

### 5. Next.js ã‚³ãƒ³ãƒ†ãƒŠã®è¨­å®š

### 6. API ã‚³ãƒ³ãƒ†ãƒŠã®è¨­å®š

## å‹•ä½œç¢ºèª

## ã¾ã¨ã‚

## å‚è€ƒ
