---
title: "sqldefã§RDSã‚’ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹Lambdaé–¢æ•°ã‚’ä½œæˆã™ã‚‹"
emoji: "ğŸ£"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["åˆæŠ•ç¨¿", "Lambda","RDS", "Go","sqldef"]
published: false
---

ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®DBã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯[sqldef](https://github.com/k0kubun/sqldef)ã¨ã„ã†ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚ã¨ã¦ã‚‚ä¾¿åˆ©ãªãƒ„ãƒ¼ãƒ«ãªã®ã§ã€æœ¬ç•ªç’°å¢ƒã§ã‚‚ä½¿ç”¨ã—ãŸã„ã§ã™ã€‚

ãŸã ã—ã€ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã®RDSã‚’ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹å ´åˆã¯ã„ãã¤ã‹ã®èª²é¡ŒãŒã‚ã‚Šã¾ã™ã€‚è¸ã¿å°çµŒç”±ã§å®Ÿè¡Œã™ã‚‹ã®ã¯é¢å€’ã§ã™ã—ã€è¸ã¿å°ã¨ãªã‚‹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å¸¸æ™‚ç«‹ã¦ã¦ãŠãã®ã¯ã‚³ã‚¹ãƒˆãŒã‹ã‹ã‚Šã¾ã™ã€‚

ã“ã‚Œã‚‰ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã€ä»Šå›ã¯CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«çµ„ã¿è¾¼ã¿ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è‡ªå‹•åŒ–ã™ã‚‹Lambdaé–¢æ•°ã®ä½œæˆã«å–ã‚Šçµ„ã‚“ã§ã¿ã¾ã—ãŸã€‚

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã«ã‚ã‚Šã¾ã™ã€‚
https://github.com/kngnkg/tunetrail/tree/main/migration

## `sqldef`ã«ã¤ã„ã¦

[sqldef](https://github.com/k0kubun/sqldef)ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã®å®šç¾©ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©ã—ãŸ`.sql`ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¿…è¦ãªDDLã‚’è‡ªå‹•ã§ç”Ÿæˆã—å®Ÿè¡Œã—ã¦ãã‚Œã¾ã™ã€‚

`sqldef`ã¯CLIãƒ„ãƒ¼ãƒ«ã§ã™ãŒã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦Goã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‹ã‚‰ç›´æ¥å‘¼ã³å‡ºã™ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

## AWS Lambdaé–¢æ•°

[Go](https://go.dev/#)ã§å®Ÿè£…ã—ã¾ã—ãŸã€‚S3ã«ä¿å­˜ã—ãŸ`.sql`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã€`sqldef`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

è©³ç´°ã¯[ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/kngnkg/tunetrail/tree/main/migration)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

```go
type Event struct {
	Items []string `json:"items"`
}

type Response struct {
	Result string `json:"result"`
}

func getSchemaFilesFromS3(ctx context.Context, region string, S3Bucket string, objectKeys []string) ([]string, error) {
	sess, err := session.NewSession(&aws.Config{
		Region: aws.String(region),
	})
	if err != nil {
		return nil, err
	}

	s3dl := s3downloader.New(sess, S3Bucket)
	var files []string
	for _, objectKey := range objectKeys {
		file, err := s3dl.Download(ctx, objectKey)
		if err != nil {
			return nil, err
		}
		files = append(files, file.Name())
	}
	return files, nil
}

func migrate(ctx context.Context, cfg *config.Config, files []string) error {
	desiredFiles := sqldef.ParseFiles(files)
	desiredDDLs, err := sqldef.ReadFiles(desiredFiles)
	if err != nil {
		return err
	}

	options := &sqldef.Options{
		DesiredDDLs: desiredDDLs,
		DryRun:      cfg.DryRun,
	}

	dbCfg := database.Config{
		DbName:   cfg.DBName,
		User:     cfg.DBUser,
		Password: cfg.DBPassword,
		Host:     cfg.DBHost,
		Port:     cfg.DBPort,
	}

	db, err := postgres.NewDatabase(dbCfg)
	if err != nil {
		return err
	}

	sqlParser := postgres.NewParser()

	if cfg.Env == "dev" {
		os.Setenv("PGSSLMODE", "disable")
	}
	sqldef.Run(schema.GeneratorModePostgres, db, sqlParser, options)
	return nil
}

func handleRequest(ctx context.Context, event Event) (Response, error) {
	cfg, err := config.New()
	if err != nil {
		log.Fatalf("Error loading config: %v", err)
	}

	files, err := getSchemaFilesFromS3(ctx, cfg.AWSRegion, cfg.S3Bucket, event.Items)
	if err != nil {
		log.Fatalf("Error getting schema file: %v", err)
	}

	if err := migrate(ctx, cfg, files); err != nil {
		log.Fatalf("Error migration: %v", err)
	}

	return Response{Result: "Success"}, nil
}

func main() {
	lambda.Start(handleRequest)
}

```

### Dockerfile

ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºã‚’å‰Šæ¸›ã—ã¾ã™ã€‚[è©³è§£Goè¨€èªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™º](https://www.amazon.co.jp/%E8%A9%B3%E8%A7%A3Go%E8%A8%80%E8%AA%9EWeb%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E9%96%8B%E7%99%BA-%E6%B8%85%E6%B0%B4-%E9%99%BD%E4%B8%80%E9%83%8E/dp/4863543727)ã‚’å‚è€ƒã«ã—ã¾ã—ãŸã€‚

```Dockerfile
FROM golang:1.20.3-bullseye as deploy-builder

WORKDIR /app

COPY go.mod go.sum ./
RUN go mod download

COPY . .

RUN go build -trimpath -ldflags "-w -s" -o app

# ---------------------------------------------------

FROM debian:bullseye-slim as deploy

COPY --from=deploy-builder /app/app .

CMD ["./app"]

```

## ä½¿ã„æ–¹


## ã¾ã¨ã‚



## å‚è€ƒè³‡æ–™

https://qiita.com/crossroad0201/items/98f8935b4da1118566a4

https://zenn.dev/tchssk/articles/27a6c6c8aba40d
