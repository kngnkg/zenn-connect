---
title: "sqldefでRDSをマイグレーションするLambda関数を作成する"
emoji: "🐣"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["初投稿", "Lambda","RDS", "Go","sqldef"]
published: false
---

ローカル環境でのDBのマイグレーションは[sqldef](https://github.com/k0kubun/sqldef)というツールを使用しています。とても便利なツールなので、本番環境でも使用したいです。

ただし、プライベートサブネットのRDSをマイグレーションする場合はいくつかの課題があります。踏み台経由で実行するのは面倒ですし、踏み台となるインスタンスを常時立てておくのはコストがかかります。

これらの問題を解決するため、今回はCI/CDパイプラインに組み込み、マイグレーションを自動化するLambda関数の作成に取り組んでみました。

ソースコードは以下にあります。
https://github.com/kngnkg/tunetrail/tree/main/migration

## `sqldef`について

[sqldef](https://github.com/k0kubun/sqldef)は、データベーススキーマの定義を管理するためのコマンドラインツールです。スキーマを定義した`.sql`ファイルから必要なDDLを自動で生成し実行してくれます。

`sqldef`はCLIツールですが、ライブラリとしてGoのプログラムから直接呼び出すことも可能です。

## AWS Lambda関数

[Go](https://go.dev/#)で実装しました。S3に保存した`.sql`ファイルを読み込んで、`sqldef`パッケージでマイグレーションを実行します。

詳細は[リポジトリ](https://github.com/kngnkg/tunetrail/tree/main/migration)を参照してください。

```go
type Event struct {
	Items []string `json:"items"`
}

type Response struct {
	Result string `json:"result"`
}

func getSchemaFilesFromS3(ctx context.Context, region string, S3Bucket string, objectKeys []string) ([]string, error) {
	sess, err := session.NewSession(&aws.Config{
		Region: aws.String(region),
	})
	if err != nil {
		return nil, err
	}

	s3dl := s3downloader.New(sess, S3Bucket)
	var files []string
	for _, objectKey := range objectKeys {
		file, err := s3dl.Download(ctx, objectKey)
		if err != nil {
			return nil, err
		}
		files = append(files, file.Name())
	}
	return files, nil
}

func migrate(ctx context.Context, cfg *config.Config, files []string) error {
	desiredFiles := sqldef.ParseFiles(files)
	desiredDDLs, err := sqldef.ReadFiles(desiredFiles)
	if err != nil {
		return err
	}

	options := &sqldef.Options{
		DesiredDDLs: desiredDDLs,
		DryRun:      cfg.DryRun,
	}

	dbCfg := database.Config{
		DbName:   cfg.DBName,
		User:     cfg.DBUser,
		Password: cfg.DBPassword,
		Host:     cfg.DBHost,
		Port:     cfg.DBPort,
	}

	db, err := postgres.NewDatabase(dbCfg)
	if err != nil {
		return err
	}

	sqlParser := postgres.NewParser()

	if cfg.Env == "dev" {
		os.Setenv("PGSSLMODE", "disable")
	}
	sqldef.Run(schema.GeneratorModePostgres, db, sqlParser, options)
	return nil
}

func handleRequest(ctx context.Context, event Event) (Response, error) {
	cfg, err := config.New()
	if err != nil {
		log.Fatalf("Error loading config: %v", err)
	}

	files, err := getSchemaFilesFromS3(ctx, cfg.AWSRegion, cfg.S3Bucket, event.Items)
	if err != nil {
		log.Fatalf("Error getting schema file: %v", err)
	}

	if err := migrate(ctx, cfg, files); err != nil {
		log.Fatalf("Error migration: %v", err)
	}

	return Response{Result: "Success"}, nil
}

func main() {
	lambda.Start(handleRequest)
}

```

### Dockerfile

マルチステージビルドでイメージサイズを削減します。[詳解Go言語Webアプリケーション開発](https://www.amazon.co.jp/%E8%A9%B3%E8%A7%A3Go%E8%A8%80%E8%AA%9EWeb%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E9%96%8B%E7%99%BA-%E6%B8%85%E6%B0%B4-%E9%99%BD%E4%B8%80%E9%83%8E/dp/4863543727)を参考にしました。

```Dockerfile
FROM golang:1.20.3-bullseye as deploy-builder

WORKDIR /app

COPY go.mod go.sum ./
RUN go mod download

COPY . .

RUN go build -trimpath -ldflags "-w -s" -o app

# ---------------------------------------------------

FROM debian:bullseye-slim as deploy

COPY --from=deploy-builder /app/app .

CMD ["./app"]

```

## 使い方


## まとめ



## 参考資料

https://qiita.com/crossroad0201/items/98f8935b4da1118566a4

https://zenn.dev/tchssk/articles/27a6c6c8aba40d
